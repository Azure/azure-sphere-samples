# Sample: HelloWorld_HighLevelApp_CMake

This sample shows how to use CMake to build an Azure Sphere high-level application. This repository contains a sample CMake project that uses the same code as the [Azure Sphere Blink template](https://docs.microsoft.com/azure-sphere/quickstarts/qs-blink-application#build-and-run-the-blink-sample).

CMake is an available component in Visual Studio. Installing the Azure Sphere SDK should trigger the installation of CMake, or it can be installed in Visual Studio manually. The Azure Sphere SDK for Visual Studio supplies the supporting CMake toolchain files that configure CMake to build Azure Sphere applications with the appropriate cross compilers and compilation flags.

The sample contains three files in addition to the usual Azure Sphere Blink template files:

- CMakeLists.txt contains the project information and produces the build.
- CMakeSettings.json configures Visual Studio to use CMake with the correct command-line options.
- launch.vs.json tells Visual Studio how to deploy and debug the application.

To use this sample, clone the repository locally if you haven't already done so:

     `git clone https://github.com/Azure/azure-sphere-samples.git`

By default, this sample targets [MT3620 reference development board (RDB)](https://docs.microsoft.com/azure-sphere/hardware/mt3620-reference-board-design) hardware, such as the MT3620 development kit from Seeed Studios. To set the target hardware for an application, set the CMakeSettings.json fields to use the corresponding hardware definition. You can use the definition files that are supplied with the samples or other files supplied by the hardware vendor.

**To target alternative hardware**

 Set the Target Hardware Definition Directory for your hardware.
 The Target Hardware Definition Directory identifies the folder that contains the hardware definition files for the target hardware. This path is relative to the workspace of the project. 

   - Edit the **AzureSphereTargetHardwareDefinitionDirectory** field in the CMakeSettings.json file. For example:

      ```json
      "AzureSphereTargetHardwareDefinitionDirectory": "..\\..\\..\\Hardware\\seeed_mt3620_rdb",
      ```

The sample already specifies the required target hardware definition, sample_hardware.json. This file is supplied in the Hardware folder in the samples repository. 

## To build and deploy with Visual Studio

1. Start Visual Studio. From the **File** menu, select **Open > CMake...** and navigate to the folder that contains the sample.
1. Select the file CMakeLists.txt and then click **Open**
1. From the **CMake** menu (if present), select **Build All**. If the menu is not present, open Solution Explorer, right-click the CMakeLists.txt file, and select **Build**. This will build the application and create an imagepackage file. The output location of the Azure Sphere application appears in the Output window.
1. From the **Select Startup Item** menu, on the tool bar, select **GDB Debugger (HLCore)**.
1. Press F5 to start the application with debugging. LED 1 begins to blink.


## To build and deploy from the command line

Use the Developer Command Prompt for VS 2017, or Developer Command Prompt for VS 2019, as they already include the paths for CMake and Ninja. The following commands prepare the build files for the HelloWorld_HighLevelApp_CMake sample application from the command line:

```sh
mkdir build
cd build

cmake.exe ^
-G "Ninja" ^
-DCMAKE_INSTALL_PREFIX:PATH="." ^
-DCMAKE_TOOLCHAIN_FILE="C:/Program Files (x86)/Microsoft Azure Sphere SDK/CMakeFiles/AzureSphereToolchain.cmake" ^
-DAZURE_SPHERE_TARGET_API_SET="3" ^
-DAZURE_SPHERE_TARGET_HARDWARE_DEFINITION_DIRECTORY="%CD%/../../../../Hardware/mt3620_rdb" ^
-DAZURE_SPHERE_TARGET_HARDWARE_DEFINITION="sample_hardware.json" ^
--no-warn-unused-cli ^
-DCMAKE_BUILD_TYPE="Debug" ^
-DCMAKE_MAKE_PROGRAM="ninja.exe" ^
..
```

To complete the process, run Ninja.exe to build the application and create the imagepackage file:
```
ninja
```

### To deploy the application generated by CMake

Open an Azure Sphere Developer Command Prompt. Change to the directory that contains the image package and run the **azsphere device sideload deploy** command:

    `azsphere.exe device sideload deploy --imagepackage HelloWorld_HighLevelApp_CMake.imagepackage`

### CMake parameters

`-DCMAKE_TOOLCHAIN_FILE `

This is a standard CMake flag to configure the use of a compiler toolchain. The example above passes the default location of the toolchain file that is installed with the Azure Sphere SDK.

`-DAZURE_SPHERE_TARGET_API_SET `

This flag is provided by the Azure Sphere toolchain file. The value is the desired Azure Sphere API set to use such as "3+Beta1909". In the example it is set to 3.

`-DCMAKE_BUILD_TYPE`

This flag indicates the build type. Possible values are debug and release.

`-DCMAKE_MAKE_PROGRAM`

This flag indicates the make program to use, and in the sample is set to use ninja.exe.

`-DAZURE_SPHERE_TARGET_HARDWARE_DEFINITION_DIRECTORY`

Sets the location of the hardware definition folder.

`-DAZURE_SPHERE_TARGET_HARDWARE_DEFINITION`

Indicates the hardware definition to use for the application.

## Troubleshooting the Azure Sphere app

When opening the project, you see the following error in the Error List:

```
CMake Error: CMAKE_C_COMPILER not set, after EnableLanguage
CMake Error at C:/Program Files (x86)/Microsoft Azure Sphere SDK/CMakeFiles/AzureSphereToolchainBase.cmake:72 (MESSAGE):
  C:/Work/HelloWorld_HighLevelApp_CMake/../../../Hardware/mt3620_rdb/sample_hardware.json does not exist
```

This error may occur for many reasons. Most often, the reason is that you did not clone the entire Azure Sphere Samples repository from GitHub. The samples depend on the hardware definition files that are supplied in the Hardware folder of the repository.

## License
For license details, see LICENSE.txt.

## Code of Conduct
This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/).
